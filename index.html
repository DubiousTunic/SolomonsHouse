<html>
<!-- 
	TODO: !pagination showing after delete
	TODO: top 10
	TODO: realtime seeders/leechers
	TODO: title is member of class
	TODO: two back buttons needed when title clicked (?)
	TODO: extra comma on title page for tags (?)
	TODO: find way to regulate deletions (of titles)
	TODO: show media type on browse page (etc)
	TODO: sort by date doesn't seem to work
	TODO: forums sometimes doesn't load
	TODO: more on top 10, classes frontend	TODO: 
	TODO: seed images clientside rather than external linking them...this also req editing doc edit page OR encourage imgur uploads
	TODO: size, snatches in title row
	TODO: seeders/leechers
	TODO: press enter to search
	TODO: disable autocomplete
	TOOD: one day update pagination so it has a constant # of pages
	TODO: taglist route should reduce pages
	TODO: identical titles
	TODO: publisher dupe
	TODO: ranges in year search
	TODO: sort/orderby on classes and persons
	TODO: person names unique?
	TODO: only show 1 of each forum realtime search
	TODO: make a search reset button
	TODO: pages in comment section
	TODO: tag collection (?)
!-->
	<head>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>		
		<script src="http://momentjs.com/downloads/moment.min.js"></script>
	</head>
	<body>

		
		<h1><a href="/index">SolomonsHouse</a></h1>
		<ul class="panel">
			<li><a href="/upload" class="upload_route">Upload</a></li>
		</ul>
		<ul class="heading">			
			
			<li><a href="/torrents" class="torrents_route">Torrents</a></li>			
			<li><a href="/classes" class="classes_route">Classes</a></li>
			<li><a href="/top10" class="top10_route">Top 10</a></li>
			<li><a href="/forums" class="forums_route">Forums</a></li>
		</ul>
		<ul class="search_bar">
			<li>
				<form class="adv_search" id="search_titles">
					<input placeholder="titles" id="titles" autocomplete="off" name="text">
				</form>
				<div id="realtime_titles" class="realtime_search">
					
				</div>
			</li>
			<li>
				<form class="adv_search" id="search_persons">
					<input placeholder = "persons" id="persons" autocomplete="off" name="text">
				</form>
				<div id="realtime_persons" class="realtime_search">
					
				</div>
			</li>
			<li>
				<form class="adv_search" id="search_classes">
					<input placeholder = "classes" id="classes" autocomplete="off" name="text">
				</form>
				<div id="realtime_classes" class="realtime_search">
					
				</div>
			</li>
			<li>
				<form class="adv_search" id="search_forums">
					<input placeholder = "forums" id="forums" autocomplete="off" name="text">
				</form>
				<div id="realtime_forums" class="realtime_search">
					
				</div>
			</li>
		</ul>
		<div id="hero">
	      <div id="output">
	        <div id="progressBar"></div>
	        <!-- The video player will be added here -->
	      </div>
	      <!-- Statistics -->
	      <div id="status">
	        <div>
	          <span class="show-leech">Downloading </span>
	          <span class="show-seed">Seeding </span>
	      
	          <span class="show-leech"> from </span>
	          <span class="show-seed"> to </span>
	          <code id="numPeers">0 peers</code>.
	        </div>
	        <div>
	          <code id="downloaded"></code>
	          of <code id="total"></code>
	          â€” <span id="remaining"></span><br/>
	          &#x2198;<code id="downloadSpeed">0 b/s</code>
	          / &#x2197;<code id="uploadSpeed">0 b/s</code>
	        </div>
	      </div>
    </div>
    <div id="wrapper">
    </div>
		<br><br>
			<div class="log">
		</div>

		<div class="partial index_partial">
			<div class="indexPost">
				<div class="postHeading"><span>Most recent torrents</span></div>
				<div id="indexTiles"></div>
			</div>			
			<div class="indexPost">
				<div class="postHeading"><span id="spanRight">1622912660554</span></div>
				<div>
				<p>News will also be offered here alongside Art.</p></div>
			</div>
			<div class="indexPost">
				<div class="postHeading"><span id="spanRight">1622903714731</span></div>
				<div>
				<p>Ebooks; audiobooks; classical music; art; documentaries</p></div>
			</div>
			<div class="indexPost">
				<div class="postHeading"><span id="spanRight">1622902269625</span></div>
				<div>
				<p>Masterful, modest, feast thou with the gods.</p></div>
			</div>
		</div>

		<div class="partial top10_partial">
			<h2><a href>Top 10 Titles this Day</a></h2>
			<div class="collage" id="collage_day">
				
			</div>

			<h2><a href>Top 10 Titles this Week</a></h2>
			<div class="collage" id="collage_week">
				
			</div>

			<h2><a href>Top 10 Titles this Month</a></h2>
			<div class="collage" id="collage_month">
				
			</div>

			<h2><a href>Top 10 Titles this Year</a></h2>
			<div class="collage" id="collage_year">
				
			</div>

			<h2><a href>Top 10 Titles of All Time</a></h2>
		    <div class="collage" id="collage_time">
				
			</div>
		</div>

		<div class="partial forums_partial">
			<h2>Forums</h2>
			<div class="pagination">

			</div>
		</div>

		<div class="partial forums_post_partial">
			<h2>Post</h2>
			<form class="forums_post" action="/forum_post" method="POST">
				<input placeholder="tripcode" name="tripcode"><br>
				<input id="threadTitle" placeholder="thread title" name="threadTitle">
				<br>
				<textarea class="forum_textarea" name='postBody' placeholder="post here"></textarea><br><br>
				<button>Submit</button>
				<div class="forums_post_div"></div>
			</form>
		</div>
		
		<div class="partial gazelle_partial">
			<button class="edit">Edit doc</button>
			<br>
			<h2>Document</h2><br>
			<a class="subhead"><h3></h3></a>
			<br>
			<img class="gaz_img"><br><br>
			<p class="description"></p>
			<br>
			<table class="main_table">
				<thead>
					<tr>
						<th class="gaz_style"></th><th>Name / Year / Persons</th><th>Time</th><th>Size</th><th>Snatches</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table><br>
			<div class="collage">

			</div>

			<div id="commentArea"></div>
			
		</div>

		<div class="partial edit_doc_partial">
			<h2>Edit doc</h2>
			<form method="POST" class="edit_doc">
				<input placeholder = "title" name="doc_name"><br>
				<input name="doc_person" id="doc_person" placeholder="person"><select id="docPersonImportance"><option value="author">Author</option><option value="Director">Director</option><option value="editor">Editor</option><option value="translator">Translator</option></select><input id="docPersonRole"><button id="doc_add_person">add person</button><button id="doc_create_person">create person</button><br>
				<input placeholder="date" name="doc_date"><br>
				<input placeholder="img url" name="doc_img"><br>
				<input placeholder="tags (comma separated)" name="doc_tags"><br>
				<br><textarea placeholder = "description" name="doc_description"></textarea><br>
				<br><input class="add_titles" placeholder="title id (submit to add to class)" name="doc_title_id">	
				<br><br><br>
				*<input class="add_nonpersons" placeholder="person name to delete" name="nonpersons"><br>
				*<input class="add_nontags" placeholder="tag name to delete" name="nontags"><br>
				*<input class="add_nontorrents" placeholder="torrent to delete (infoHash)" name="nontorrents"><br>	
						
				<br><br>
				*indicates field must be submitted by itself

				<input type="submit" value="Submit">
			</form>

		</div>

		<div class="partial classes_partial">
			<br>
		<h2>Classes</h2>
			<a class="add_class" href="#">Add class</a>
			<table class="main_table">
				<thead>
					<tr>
						<th class="gaz_style"></th><th>Name</th><th>Tags</th><th>#</th><th>Time</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table><br>
			<div class="pagination">

			</div>
			<br>
		</div>

		<div class="partial add_class_partial">
			<br>
			<h2>Add Class</h2>
			<form class="create_class" action="/create_class" method="POST">
				<input name="name" placeholder="Title"><br>
				<input name="tags" placeholder="tags (comma separated)"><br>
				<input type="submit" value="Submit"> 
			</form>
		</div>
	
		<!--this is the main browse partial. i just call them 'partials'. they are divs that are dy-
		namically loaded with jquery. when a partial is called all .partial are hidden. a router is behind this !-->
		<div class="partial titles_partial">
			<br>
		<h2><a href>Torrents</a></h2>
			<div class="basicSearch">
				<span id="switchAdvancedSearch"><a href>Switch to Advanced Search</a></span>
				<span id="switchBasicSearch"><a href>Switch to Basic Search</a></span><br>
				<form>
					<input name="terms" id="searchTerms" placeholder="terms"><br>
					<input name="tags" id="searchTags" placeholder="tags (comma separated)">
					<ul>
						<li><label><input id="search_type_0" type="checkbox" name="types[0]" value="0">Nonfiction</label></li>
						<li><label><input id="search_type_1" type="checkbox" name="types[1]" value="1">Fiction</label></li>
						<li><label><input type="checkbox" id="search_type_2" name="types[2]" value="2">Classical Music</label></li>
						<li><label><input type="checkbox" id="search_type_3" name="types[3]" value="3">Art</label></li>
						<li><label><input type="checkbox" name="types[4]" id="search_type_4" value="4">Documentary</label></li>
						<li><label><input type="checkbox" name="types[5]" id="search_type_5" value="5">News</label></li>						
					</ul>
					<div class="advancedSearch">
						<input name="person" placeholder="person" id="advPerson"><br>
						<input name="date" placeholder="date" id="advDate"><br>						
						<select name="media" id="advMedia">
							<option value="">Media</option>
							<option value="ebook">ebook</option>
							<option value="scan">ebook (scan)</option>											
							<option value="img">img</option>
							<option value="dvd">WEB</option>
							<option value="dvd">DVD</option>
							<option value="blu-ray">Blu-Ray</option>
							<option value="cd">CD</option>
							<option value="vinyl">Vinyl</option>				
						</select>
						<br>
						<!--CONTAINER (MKV), FORMAT (PDF) !-->
						<select name="format" id="advFormat">
							<option value="">Format</option>
							<option value="pdf">.pdf</option>
							<option value="mp3">.mp3</option>
							<option value="jpg">.jpg</option>
							<option value="png">.png</option>
							<option value="gif">.gif</option>
							<option value="webm">.webm</option>
							<option value="mkv">.mkv</option>
							<option value="avi">.avi</option>
						</select>
						<br>
						<!--BITRATE, RESOLUTION !-->
						<select name="bitrate" id="advBitrate">
							<option value="">Bitrate</option>
							<option value="text">text</option>
							<option value="graphic">graphic</option>				
							<option value="variable">audio</option>
							<option value="lossless">video</option>					
						</select>
						<br>							
						<input id="advPublisher" placeholder="publisher or journal"><br>
						<input id="advEdition" placeholder="edition, volume, editors"><br>
						<input id="advNumber" placeholder="no., pub date"><br>
						<input id="advPages" id="pages" placeholder="pages, article #"><br>
					</div>
					<br>					
					<input type="submit" style="display: none" />
					<input id="inputButton" type="submit" value="Search">
				</form>
			</div>
			<table class="main_table">
				<thead>
					<tr>
						<th class="gaz_style"></th><th><a href id='sortName'>Name</a> / <a href id='sortDate'>Year</a> / Persons</th><th><a href id='sortTime'>Time</a></th><th><a href id='sortSize'>Size</a></th><th><a href id='sortSnatches'>Snatches</a></th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table><br>
			<div class="pagination">

			</div>
			<br>
		</div>


		<div class="partial upload_partial"><br>
		<h2>Upload</h2>
		<form class="upload" action="/new_upload" method="POST">
			<input name="tripcode" id="tripcode" placeholder="tripcode">
			<br>
			<br>
			<!--FORMERLY, MUSIC, Ebooks, etc !-->
			<select name="type">
				<option value="nonfiction">Nonfiction</option>
				<option value="fiction">Fiction</option>				
				<option value="music">Classical Music</option>
				<option value="art">Art</option>
				<option value="documentary">Documentary</option>
				<option value="news">News</option>
			</select>
			<br>
			<!-- this would be like, ALBUM, SINGLE, etc. !-->
			<select name="release"> 
				<option value="book">Book</option>
				<option value="audiobook">Audiobook</option>				
				<option value="lecture">Lecture</option>
				<option value="img">Image</option>
				<option value="periodical">Periodical</option>
				<option value="textbook">Textbook</option>
				<option value="encyclopedia">Encyclopedia</option>
				<option value="news">News</option>
				<option value="single">Single</option>
				<option value="album">Album</option>
				<option value="anthology">Anthology</option>
				<option value="film">Feature Film</option>
			</select>
			<br>
			<input name="name" placeholder="title">
			<br>
			<input name="date" placeholder="date"><br>
			<input name="img" placeholder="img url"><br>
			<input id="upload_person" name="person" placeholder="person"><select id="personImportance"><option value="author">Author</option><option value="Director">Director</option><option value="editor">Editor</option><option value="translator">Translator</option></select><input id="personRole" placeholder="role"><button class="add_person">add person</button><button class="create_person">create person</button>
			<br>
			<br>			
			
			<!--MEDIA SOURCE (EBOOK, AUDIOBOOK, NEWS ARTICLE) !-->
			<select name="media">
				<option value="ebook">ebook</option>
				<option value="scan">ebook (scan)</option>											
				<option value="img">img</option>
				<option value="dvd">WEB</option>
				<option value="dvd">DVD</option>
				<option value="blu-ray">Blu-Ray</option>
				<option value="cd">CD</option>
				<option value="vinyl">Vinyl</option>				
			</select>
			<br>
			<!--CODEC IF APPLICABLE !-->
			<select name="codec">
				<option value="">Codec</option>
				<option value="x264">x264</option>				
			</select>
			<br>
			<!--CONTAINER (MKV), FORMAT (PDF) !-->
			<select name="format">
				<option value="pdf">.pdf</option>
				<option value="mp3">.mp3</option>
				<option value="jpg">.jpg</option>
				<option value="jpeg">.jpeg</option>
				<option value="png">.png</option>
				<option value="gif">.gif</option>
				<option value="webm">.webm</option>
				<option value="mkv">.mkv</option>
				<option value="avi">.avi</option>
			</select>
			<br>
			<!--BITRATE, RESOLUTION !-->
			<select id="select_bitrate" name="bitrate">
				<option value="text">text</option>
				<option value="graphic">graphic</option>				
				<option value="variable">audio</option>
				<option value="lossless">video</option>		
			</select>
			<br>	
			<input name="publisher" placeholder="publisher or journal"><br>
			<input name="edition" placeholder="edition, volume, editors"><br>
			<input name="number" placeholder="no., pub date"><br>
			<input name="pages" placeholder="pages, article #"><br>
			<!-- location is included so that APA format can be generated in the future !-->
			<input name="location" placeholder="location">
			<br><br>
			<input name="tags" placeholder="tags (comma separated)">
			<br><br>
			<input type="file" multiple><br>	
			<input id="infoHash" name="infoHash" placeholder="infoHash"><br>
			<br><textarea name="description" placeholder="Description"></textarea><br>
			<input type="submit" value="Submit">
		</form>
		</div>
		<script>

			$(document).ready(function(){

				$(".index_partial .postHeading").each(function(index){
					var mil = $(this).text()
					$(this).find("#spanRight").text(timeSince(mil));
				})

				$(".heading a").click(function(e){
					e.preventDefault();
				})

				var client = new window.WebTorrent();


				// HTML elements
		      var $body = document.body
		      var $progressBar = document.querySelector('#progressBar')
		      var $numPeers = document.querySelector('#numPeers')
		      var $downloaded = document.querySelector('#downloaded')
		      var $total = document.querySelector('#total')
		      var $remaining = document.querySelector('#remaining')
		      var $uploadSpeed = document.querySelector('#uploadSpeed')
		      var $downloadSpeed = document.querySelector('#downloadSpeed')

		      function getBrowseStr(){
		      	const urlParams = new URLSearchParams(window.location.search);
		      	var browseStr = "?search=" + urlParams.get('search') + "&page=" + urlParams.get('currentPage') + "&taglist="+urlParams.get('taglist') +"&tags="+urlParams.get('tags')+"&terms="+urlParams.get('terms')+"&types="+ urlParams.get('types') +"&publisher="+urlParams.get('publisher')+"&date="+urlParams.get('date')+"&format="+urlParams.get('format')+"&person="+urlParams.get('person') + "&bitrate="+urlParams.get('bitrate')+"&media="+urlParams.get('media')+"&edition="+urlParams.get('edition')+"&number="+urlParams.get('number')+"&pages="+urlParams.get('pages') + "&action=" + urlParams.get('action')
		      	return browseStr;
		      }


		      function switchOrder(order){
		      	if(order === "asc"){
		      		return "desc"
		      	}
		      	else if(order === "desc"){
		      		return "asc"
		      	}	
		      }

		      var sortName = "asc"

		       $("#sortName").click(function(e){
		       	e.preventDefault()
		       	sortName = switchOrder(sortName);
		      	//$.get("/browse" + getBrowseStr() + "&sort_by=name&order_by=" + sortName, function(data){
					var URL = updateURLParameter((window.location.pathname + window.location.search), "sort_by", "name")
					URL = updateURLParameter(URL, "order_by", sortName)
					route(URL)
		      	//})		      			      	
		      })

		       $("#sortName").attr("href", "")

		      var sortSnatches = "asc"
		      $("#sortSnatches").click(function(e){
		       	e.preventDefault()

		      	sortSnatches = switchOrder(sortSnatches);
		      	//$.get("/browse" + getBrowseStr() + "&sort_by=snatched&order_by=" + sortSnatches, function(data){
					var URL = updateURLParameter((window.location.pathname + window.location.search), "sort_by", "snatched")
					URL = updateURLParameter(URL, "order_by", sortSnatches)
					route(URL)
		      	//})		      			      	
		      })

		      var sortDate = "asc"
		      $("#sortDate").click(function(e){
		       	e.preventDefault()

		      	sortDate = switchOrder(sortDate);
		      //	$.get("/browse" + getBrowseStr() + "&sort_by=date&order_by=" + sortDate, function(data){
					var URL = updateURLParameter((window.location.pathname + window.location.search), "sort_by", "date")
					URL = updateURLParameter(URL, "order_by", sortDate)
					route(URL)
		      	//})		      			      	
		      })

		      var sortTime = "asc"

		      $("#sortTime").click(function(e){
		       	e.preventDefault()

		      	sortTime = switchOrder(sortTime)
		      	//$.get("/browse" + getBrowseStr() + "&sort_by=time&order_by=" + sortTime, function(data){
					var URL = updateURLParameter((window.location.pathname + window.location.search), "sort_by", "time")
					URL = updateURLParameter(URL, "order_by", sortTime)
					route(URL)
		      //	})		      			      	
		      })

		      var sortSize = "asc"
		      $("#sortSize").click(function(e){
		       	e.preventDefault()

		      	sortSize = switchOrder(sortSize);
		      //	$.get("/browse" + getBrowseStr() + "&sort_by=size&order_by=" + switchOrder(sortSize), function(data){
					var URL = updateURLParameter((window.location.pathname + window.location.search), "sort_by", "size")
					URL = updateURLParameter(URL, "order_by", sortSize)
					route(URL)
		      //	})		      			      	
		      })
			
				$(".edit").click(function(e){
					e.preventDefault();
					console.log($(this).data("collection"))
					route("/edit_doc/" + $(this).data("collection") + "/" + getSuffix($(this).attr("id")))
				})
        	
				$("h1 a").click(function(e){
					e.preventDefault();

					//route("/titles/60a3c2a499b6088985f78891")
					route("/index")
				})

				$(".torrents_route").click(function(e){
					e.preventDefault();
					currentPage = 1;
					route("/torrents")
				})

				$(".upload_route").click(function(e){
					e.preventDefault();
					route("/upload");					
				})

				$(".top10_route").click(function(e){
					e.preventDefault();
					route("/top10")
				})

				$(".forums_route").click(function(e){
					e.preventDefault();
					currentPage = 1;
					route("/forums")
				})

				$(".classes_route").click(function(e){
					e.preventDefault();
					currentPage = 1;
					route("/class")
				})

				$(".add_class").click(function(e){
					e.preventDefault();
					route("/add_class")
				})

				$(".create_class").submit(function(e){
					route("/index")
				})
				var currentPage = 1;

				function route(path){	
					console.log(path);				
					history.pushState(path, '', path)
					$(".partial").hide();
					
					var query = path.split("?")
					console.log("QUERY: " + query[1])
					var pathway = query[0].split("/");
					router(pathway[1], query[1], {id : pathway[2], collection : pathway[1]})			
				}

				var path = window.location.pathname + window.location.search;
				route(path)

				window.addEventListener('popstate', function(event){
					console.log("BACK BUTTON : "+ event.state);
					var path = event.state;
					//route(path);
					if(path !== null){
						var query = path.split("?")
						var pathway = query[0].split("/");	
						$(".partial").hide();
					//	console.log("HERE IS THE ROUTING PATHWAY : " + pathway)

						router(pathway[1], query[1], {id : pathway[2], collection : pathway[1]});		
					}
									
				})
			

				function router(route, query, params){
					console.log("QUERY : " + query)
					console.log("routing to " + route)
					var id = params.id;
					var col = params.collection;
					const urlParams = new URLSearchParams(window.location.search);
					const taglist = urlParams.get('taglist');
					const page = urlParams.get('page');
					const view = urlParams.get('view');
					const doc = urlParams.get('doc');
					const terms = urlParams.get('terms');

					const tags = urlParams.get('tags');
					const types = urlParams.get("types");
					const search = urlParams.get("search")

					const publisher= urlParams.get('publisher');
					const date = urlParams.get('date');
					const format = urlParams.get('format');
					const person = urlParams.get('person')

					const action = urlParams.get("action");

					const bitrate = urlParams.get('bitrate');
					const media = urlParams.get("media");
					const edition = urlParams.get("edition");
					const number = urlParams.get("number");
					const pages = urlParams.get("pages");

					const sort_by = urlParams.get("sort_by");
					const order_by = urlParams.get("order_by");

					const torrent_details = urlParams.get("torrent_details");
					console.log(id);
					switch(route){ 
						case "index":
							load_index();
							break;
						case "torrents":
							if(page) currentPage = page;
							load_torrents(sort_by, order_by, taglist, terms, tags, types, search, publisher, date, format, person, bitrate, media, edition, number, pages, action);
							load_basic_search(action);
							paginate();
							break;
						case "upload":
							load_upload();
							break;
						case "forums_post":
							load_forums_post(view, doc);
							break;
						case "class" :
							if(page) currentPage = page;						
							load_classes();
							paginate();
							break;
						case "titles":												
							load_doc("titles", id, torrent_details);							
							break;
						case "classes":					
							load_doc("classes", id, null);							
							break;	
						case "persons":					
							load_doc("persons", id, null);							
							break;			
						case "add_class" : 
							load_add_class();
							break;
						case "edit_doc" :
							load_edit_doc(col, id);
						 	break;
						case "top10":
							load_top10();
							break;
						case "forums":
							if(page) currentPage = page
							load_forums(view, doc);
							//paginate();
							break;
						default:
							load_index();
							break;
					}		
				}

				var forumSections = [ {
					name : "Bugs", group : 1 }, { name: "Suggestions", group : 1 }, {name : "Site Discussion", group : 1 }, { name :"General Chat", group : 2 }, { name :"BitTorrent", group : 2}, {name :"The Library", group: 2 },{name :"Classical Music", group: 2}
				]

				function load_forums(view, doc){
					//show 1st thread
					//"?view=thread&doc=1"
					//show 17th forum section
					//"?view=section&doc=17"
					$(".forums_partial").empty();
					if(!view){
						//put your forum section groups here, for example Bugs forum section is grouped under SolomonsHouse
						var h31 = document.createElement('h3');
						$(h31).text("SolomonsHouse")
						var h32 = document.createElement('h3');
						$(h32).text("General Discussion")				
						
						var table1 = document.createElement('table');
						$(table1).addClass("main_table");
						$(table1).attr('id', "table_1")

						var table2 = document.createElement("table");
						$(table2).addClass("main_table")
						$(table2).attr('id', "table_2")

						$(".forums_partial").append(h31)
						$(".forums_partial").append("<br>")
						$(".forums_partial").append(table1);
						$(".forums_partial").append("<br>")
						$(".forums_partial").append(h32)
						$(".forums_partial").append("<br>")
						$(".forums_partial").append(table2);
						$(".main_table").append("<tr><th class='gaz_style'></th><th class='section_td'>Section</th><th class='last_post_td'>Last post</th>")
						
						//table1: SolomonsHouse related forum sections
						//table2: General Discussion
						$.get("/forum", function(data){
							console.log(data);
							var sectionsLastPost = [];
							data.result.forEach(function(post){
								//this belongs to section 3 even though it's lsited first (wat)
								if(!sectionsLastPost.includes(post.section)){
									console.log(post);
									//forumSections[post.section].post = post;
									console.log(post.section);
									createTR(post.section, post)
									sectionsLastPost.push(post.section);
								}
							})
							//loop through each when you get to one of that section it is the most recent
							/*for(var i = 0; i < forumSections.length; i++){
								if(sectionsLastPost[i]){
									createTR(sectionsLastPost[i].section, sectionsLastPost[i]);
								}
							}*/
						})
						
						//get all sections

						
					}					
					else if(view === "section"){
						//this is for example The Library, listing all forum threads with docID 4
						$(".forums_partial .main_table").remove();
						$.get("/forum?view="+view+"&doc="+doc+"&page="+currentPage, function(data){

							var aaa = document.createElement("a");
							$(aaa).text("Forums");
							$(aaa).attr("href", "/forums")
							$(aaa).click(function(e){
								e.preventDefault();
								route("/forums")
							})

							$(".forums_partial").append(aaa);
							$(".forums_partial").append("<br>");
							var button = document.createElement("button");
							$(button).text("Make a thread");
							$(".forums_partial").append(button);
							console.log("HERE");
							$(button).click(function(e){
								e.preventDefault();
								//doc will be a postID (mongodb id) or a section ID (0-17...)
								route("/forums_post?view="+view +"&doc="+doc);
							})


							var table = document.createElement('table');
							$(table).addClass("main_table");
							$(table).append("<tr><th class='gaz_style'></th><th>Latest</th><th id='replies'>Replies</th></tr>")
							$(".forums_partial").append("<br>")
							$(".forums_partial").append("<br>")
							$(".forums_partial").append(table);
							$(".forums_partial").append("<br>")
							

							var pag = document.createElement('div');
							$(pag).addClass("pagination");
							$(".forums_partial").append(pag)
							paginate();

							console.log(data);

							//this is a list of threads
							console.log(data.result);
							data.result.forEach(function(post){
								createTR2(post);
							})
						})
					}
					else if(view==="thread"){
						$(".thread").empty();
						$.get("/forum?view="+view+"&doc="+doc+"&page=" + currentPage, function(data){
							console.log(data)
							var button = document.createElement("button");
							$(button).text("Reply");
							
							console.log("HERE");
							$(button).click(function(e){
								e.preventDefault();
								route("/forums_post?view="+view +"&doc=" +doc)
							})

							var thread = document.createElement("div");
							$(thread).addClass("thread");

							$(".forums_partial").append(thread);

							var pag = document.createElement('div');
							$(pag).addClass("pagination");
							$(".forums_partial").append(pag)
							paginate();
														
							var e = document.createElement("span")
							console.log(data.result[0]);
							$(e).text(data.result[0].threadTitle)
							var aa= document.createElement('a');
							$(aa).text(forumSections[data.result[0].section].name)
							$(aa).attr("href", "/forums?view=section&doc="+data.result[0].section)
							$(aa).click(function(e){
								e.preventDefault();
								route("/forums?view=section&doc="+data.result[0].section)
							})

							var aaa = document.createElement("a");
							$(aaa).text("Forums");
							$(aaa).attr("href", "/forums")
							$(aaa).click(function(e){
								e.preventDefault();
								route("/forums")
							})

							$(".thread").append(aaa);
							$(".thread").append(" > ");
							$(".thread").append(aa);
							$(".thread").append(" > ");
							$(".thread").append(e)

							data.result.forEach(function(post){
								console.log(post);
								listThreadPost(thread, post);
							})
							$(".forums_partial").append(button);
						})
					}
					$(".forums_partial").show();
				}

				//TODO technically possible to route to the recent id
				$(".forums_post").submit(function(e){
					//don't prevent default..
					route("/forums");
				})

				function listThreadPost(thread, post){
					var heading= document.createElement('div');
					var forumPost = document.createElement('div')
					
					$(forumPost).addClass("post")
					$(thread).append(forumPost);
					//this recalls Thomas Pynchon's, The Crying of Lot 49
					$(heading).addClass('postHeading')
					$(forumPost).append(heading);
					var div = document.createElement('div');
				//magick style	$(div).addClass("post")
					var id = document.createElement('a');
					$(id).text(post._id);
					$(id).attr("href", "#");
					$(id).attr("id", "post_" + post._id)

					var tripSpan = document.createElement("span");
					var body = document.createElement("p");
					$(tripSpan).text(post.trip + " " + timeSince(Date.parse(post.date)));
					$(tripSpan).addClass("tripSpan");
					$(heading).append("<br>");
					heading.append(id);
					$(heading).append(tripSpan);
					
					
					var splitted = decodeHtml(post.postBody).split("\n");
					splitted.forEach(function(line){
						var e = document.createElement('p');
					  $(body).append(e);
					  $(e).text(line)
											
					  if(line.indexOf(">")==0){
					    //$(this).text($(this).text().substring(1))
					    $(e).addClass("quote")
					  }

					  if(line.indexOf(">>" > -1)){

					  }
					}) 
					$(div).append(body);
					$(forumPost).append(div);
				}

				function createTR2(post){			

					var tr = document.createElement('tr');
					var td0 = document.createElement('td');
					$(tr).append(td0);
					$(".forums_partial .main_table").append(tr)
					var td1 = document.createElement('td1');
					
					$(td0).addClass("gaz_style")
					var a = document.createElement('a');
					//workaround
					if(post.threadTitle){
						$(a).text(post.threadTitle);
					}
					else{
						$(a).text("Untitled");
					}

					var pageSpan = document.createElement('span');
					var a1 = document.createElement('a');
					var a2 = document.createElement("a")
					var a3 = document.createElement('a');
					var a4 = document.createElement('a');

					const PAGE_LIMIT = 27;


					var lastPage = Math.round(parseInt(post.postCount) / PAGE_LIMIT)
					if(lastPage >= 2){
						$(pageSpan).append(" (")
						$(pageSpan).append(a1);
						$(pageSpan).append(" ")
						$(a1).text("1")
						$(a1).attr("href", "/forums?view=thread&doc=" +post.threadID + "&page=1")
						$(a1).click(function(e){
							e.preventDefault();
							route("/forums?view=thread&doc=" +post.threadID + "&page=1")
						})
						$(pageSpan).append(a2);

						$(a2).text("2")
						$(a2).attr("href", "/forums?view=thread&doc=" + post.threadID + "&page=2")
						$(a2).click(function(e){
							e.preventDefault();
							route("/forums?view=thread&doc=" +post.threadID + "&page=2")
						})

						if(lastPage ===2){
							$(pageSpan).append(")")
						}

						if(lastPage === 3){
							$(pageSpan).append(" ")
							$(pageSpan).append(a4);
							$(pageSpan).append(")")
						}

						if(lastPage >= 4){
							$(pageSpan).append(" - ");
							$(pageSpan).append(a3);
							$(pageSpan).append(" ");
							$(pageSpan).append(a4);
							$(pageSpan).append(")")
						}						

						$(a3).text(lastPage - 1)
						$(a3).attr("href", "/forums?view=thread&doc="+post.threadID + "&page=" + (lastPage -1))
						$(a3).click(function(e){
							e.preventDefaulT();
							route("/forums?view=thread&doc="+post.threadID + "&page="+ (lastPage - 1))
						})
						$(a4).text(lastPage)
						$(a4).attr("href", "/forums?view=thread&doc="+post.threadID + "&page=" + lastPage)
						$(a4).click(function(e){
							e.preventDefaulT();
							route("/forums?view=thread&doc="+post.threadID + "&page="+ lastPage)
						})
						
					}
					

					var span = document.createElement("span");
					$(span).attr("id", "spanRight");
					$(span).text("by " + post.recentTrip + " " + timeSince(Date.parse(post.recentDate)))
					$(a).attr("href", "/forums?view=thread&doc="+post.threadID)
					$(td1).append(a);
					$(td1).append(pageSpan)
					$(td1).append(span);
					var td2 = document.createElement("td");
					$(td2).append(post.postCount)
					$(td2).css("width", 77)

					$(a).click(function(e){
						e.preventDefault();
						route("/forums?view=thread&doc="+post.threadID);
					})
					$(tr).append(td1);
					$(tr).append(td2);

				}


				//TODO: list doc #s in monogdb			
				function createTR(section, post){								

					var tr = document.createElement('tr');
					var td1 = document.createElement('td');
					//spacing
					$(tr).append(td1);
					$(td1).addClass("gaz_style")
					var td2 = document.createElement('td')
					var a = document.createElement('a');
					$(a).attr("href", "/forums?view=section&doc="+section)
					$(a).click(function(e){
						e.preventDefault();
						route("/forums?view=section&doc="+section)
					})
					$(td2).append(a)
					var td3 = document.createElement('td');
					if(post){
						var span2 = document.createElement("span");
						$(span2).attr("id", "spanLeft");

						$(td3).append(span2);
						var a2 = document.createElement('a');
						$(a2).text(decodeHtml(post.threadTitle));
						$(a2).attr("href", "/forums?view=thread&doc="+post.threadID);
						$(a2).click(function(e){
							e.preventDefault();
							route("/forums?view=thread&doc="+post.threadID);
						})
						$(span2).append(a2);
						
						$(td3).append("<span id='spanRight'>by "+ post.trip + " " + timeSince(Date.parse(post.date)) + "</span>");
					}
					$(tr).append(td2);
					$(tr).append(td3);
					
					console.log(section);
					console.log(forumSections[section]);
					var forum = forumSections[section]

					if(forum){
						$(a).text(forum.name);
						$("#table_"+ forum.group).append(tr);
					}
				}

				function load_forums_post(view, doc){
					$(".forums_post_div").empty();
					$(".forums_post_partial").show();
					$('<input />').attr('type', 'hidden')				  
				        .attr('name', "view")
				        .val(view)
				        .appendTo('.forums_post_div');
				    $('<input />').attr('type', 'hidden')				  
				        .attr('name', "section")
				        .val(doc)
				        .appendTo('.forums_post_div');	

				    if(view === "section"){
				    	$("#threadTitle").show();
				    	$('<input />').attr('type', 'hidden')				  
					        .attr('name', "thread")
					        .val('t')
					        .appendTo('.forums_post_div');
				    }
				    else if(view === "thread"){				   
				    	$('<input />').attr('type', 'hidden')				  
					        .attr('name', "threadID")
					        .val(doc)
					        .appendTo('.forums_post_div');
					    $('<input />').attr('type', 'hidden')				  
					        .attr('name', "thread")
					        .val('')
					        .appendTo('.forums_post_div');
					    $('<input />').attr('type', 'hidden')				  
					        .attr('name', "section")
					        .attr('id', 'section')					
					        .appendTo('.forums_post_div');
					    $("#threadTitle").hide();
					    $.get('/load_forums_posting?doc='+doc, function(data){
					    	console.log(data);
					    	$("#threadTitle").val(data.result.threadTitle);
					    	$("section").val(data.result.section)
					    })
					   
				    }	
				}

				function load_basic_search(action){
					if(action === "basic" || !action){
						$("#switchBasicSearch").hide();
						$("#switchAdvancedSearch").show();
						$(".advancedSearch").hide();
						console.log("height should be 300");
						$(".basicSearch").height(300)
					}
					else if(action==="advanced"){
						$("#switchAdvancedSearch").hide();
						$("#switchBasicSearch").show();
						$(".advancedSearch").show();
						console.log("Should load advanced search")
						$(".basicSearch").height(555)
					}

					$(".basicSearch").submit(function(e){
						e.preventDefault();
						console.log("submit");
						//$("#inputButton").click();
					})

					//this is here to take action
					$("#inputButton").click(function(e){
						e.preventDefault();
						//#searchTags searchTerms
						//#search_type_1
						var terms = $("#searchTerms").val();
						var tags = $("#searchTags").val();
						var publisher = $(".basicSearch #advPublisher").val();
						var date = $("#advDate").val();
						var person = $("#advPerson").val();
						var format = $("#advFormat").val();
						var edition = $("#advEdition").val();
						var number = $("#advNumber").val();
						var pages = $("#advPages").val()
						var media = $("#advMedia").val();
						var bitrate = $("#advBitrate").val();
						var types = [];
						//'5' must be edited when types are added or removed
						for(var i= 0; i < 5; i++){
							if($("#search_type_" +i).is(":checked")){
								types.push($("#search_type_" + i).val())
							}
						}
						types = encodeURIComponent(JSON.stringify(types));

						console.log(pages);
						route("/torrents?types="+types+"&tags="+tags+"&terms="+terms+"&search=true&date="+date+"&publisher="+publisher + "&person="+person+"&format="+format +"&media="+media+"&bitrate="+bitrate+"&edition="+edition + "&number="+number +"&pages="+pages+"&action="+action);

					})
				}

				$("#switchBasicSearch").click(function(e){
					e.preventDefault();	
					$("#switchBasicSearch").hide();
					$("#switchAdvancedSearch").show();
					$(".advancedSearch").hide();
					$(".basicSearch").height(300)
					console.log("routing to basic search");				
					var URL = updateURLParameter((window.location.pathname + window.location.search), "action", "basic")
					route(URL)
				})

				$("#switchAdvancedSearch").click(function(e){
					e.preventDefault();		
					$("#switchAdvancedSearch").hide();
					$("#switchBasicSearch").show();
					$(".advancedSearch").show();
					$(".basicSearch").height(555)
					console.log('routing to advanced search')			
					var URL = updateURLParameter((window.location.pathname + window.location.search), "action", "advanced")
					route(URL)
				})



				

				function load_edit_doc(collection, id){
					$(".edit_doc_partial").show();
					$(".edit_doc_partial")
					persons = []
					$(".added_person").remove();
					$("#doc_persons_upload").remove();
					$(".add_titles").hide();
					$(".edit_doc").attr("action", "/edit/" + collection + "/" + id)
					console.log("loading edit doc")
					
					if(collection === "classes"){
						$(".add_titles").show();		
					}
				}

				$(".edit_doc").submit(function(e){
					//e.preventDefault();
					$('<input />').attr('type', 'hidden')
				    	.attr('id', 'doc_persons_upload')
				        .attr('name', "doc_persons[]")
				        .val(JSON.stringify(persons))
				        .appendTo('.edit_doc');	
					route("/index");

				})

				function load_add_class(){
					$(".add_class_partial").show();
				}

				function load_top10(){
					//note the underscore here and serverside
					$(".collage").empty();
					console.log("loading top 10")
					$.get("/top_10", function(data){
						console.log(data);
						
						var dayCount = 0;
						if(data.day && data.day.length > 0){
							data.day.forEach(function(title){							
								make10Collage("day", title, dayCount);
								dayCount++;
							})	
						}
						
						
						var weekCount = 0;
						data.week.forEach(function(title){		
							console.log(weekCount);					
							make10Collage("week", title, weekCount);
							weekCount++;

						})

						var monthCount = 0;
						data.month.forEach(function(title){
							
							make10Collage("month", title, monthCount);
							monthCount++;
						})

						var yearCount = 0;
						data.year.forEach(function(title){

							make10Collage("year", title, yearCount);
							yearCount++;
						})

						var timeCount = 0
						data.time.forEach(function(title){
													
							make10Collage("time", title, timeCount);
							timeCount++;	
						})
						//show partial after server query
					$(".collage").show();
					$(".top10_partial").show();

						

					})

				}

				function make10Collage(date, title, count){
					var div = document.createElement("div");
					var a = document.createElement('a');
					var img = document.createElement("img");
					var titleSpan = document.createElement("span");
					var tagSpan = document.createElement("span");

					$(a).attr('href', "/titles/" + title._id);

					$(a).click(function(e){
						e.preventDefault();								
						route("/titles/"+title._id)
					})

					var imgURL = "https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/PDF_file_icon.svg/833px-PDF_file_icon.svg.png";

					if(title.img){
						imgURL = unescapeHtml(title.img);
					}

					$(img).attr("src", imgURL);
					$(a).append(img);

					var title_span_a = document.createElement('a');
					$(title_span_a).text(decodeHtml(title.name).toProperCase())
					$(title_span_a).attr("href", "/titles/"+title._id);
					$(titleSpan).append(title_span_a);

					$(title_span_a).click(function(e){
						e.preventDefault();
						route("/titles/"+title._id);
					})

					$(titleSpan).addClass("collageSpan");
					$(tagSpan).addClass("collageSpan");
					$(tagSpan).addClass("tagSpan");

					var collageDiv = document.createElement('div');
					$(collageDiv).addClass("collageDiv");

					var date_span = document.createElement('span');

					if(title.date){
						$(date_span).text(" [" + title.date + "] ")
					}


					var personSpan = document.createElement("span");
					$(personSpan).addClass("collageSpan");

					var personCounter = 0;
					title.persons.forEach(function(person){
						var person_span_a = document.createElement('a');
						$(person_span_a).text(decodeHtml(person.name).toProperCase());
						$(personSpan).append(person_span_a);
						if(personCounter < title.persons.length - 1){
							$(personSpan).append(", ")
						}
						$(person_span_a).attr('href', "/persons/" + person._id)

						$(person_span_a).click(function(e){
							e.preventDefault();
							route("/persons/" + person._id)
						})
						personCounter++;
					})

					var tagCounter = 0;
					title.tags.forEach(function(tag){						
						var tag_span_a = document.createElement('a')
						$(tag_span_a).text(tag)
						$(tagSpan).append(tag_span_a)
						$(tag_span_a).attr("href", "/torrents?taglist="+tag)

						if(tagCounter !== title.tags.length - 1){
							$(tagSpan).append(", ")
						}

						$(tag_span_a).click(function(e){
							e.preventDefault();
							route("/torrents?taglist="+tag)
						})
						tagCounter++;
					})

					$(div).append(a);
					$(div).append("<br>")
					$(div).append(collageDiv);
					$(collageDiv).append(titleSpan)
					$(collageDiv).append(date_span);
					if(title.persons.length > 0){
						$(collageDiv).append(" by ");
						$(collageDiv).append(personSpan);
					}
					$(collageDiv).append("<br>")
					$(collageDiv).append(tagSpan);					

				    
				    //5 to a page
				    console.log(count)
				    if(count%5 === 0){
				    	
				    	//this is a row
				    	var br = document.createElement("div")

				    	if(count < 5){
				    		$(br).attr('id', "br_1")
				    	}
				    	else{
				    		$(br).attr('id', 'br_2');
				    	}
				    	
				    	$(br).addClass("br");
				   
				    	$(".top10_partial #collage_"+date).append(br)
				    	$(".top10_partial #collage_"+date).append("<br>")
				    	
				    }
				    if(count < 5){
				    	$(".top10_partial #collage_"+date + " #br_1").append(div);
				    }
				    else{
				    	$(".top10_partial #collage_"+date + " #br_2").append(div);
				    }


				}

				//torrent_details is an infoHash.
				function load_doc(collection, id, torrent_details){
					//this loads classes, titles, and persons. torrents are embedded documents within titles.
					console.log(collection, id);
					$.get("/doc/" + id + "?collection=" + collection, function(data){
						var doc = data.doc;
						console.log(data);
						var torrents = data.torrents;
						console.log(torrents);
						$(".collage").hide();
						$(".description").empty();
						$(".main_table").show();
						if(collection === "titles"){
							$(".gazelle_partial img").attr("src", "https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/PDF_file_icon.svg/833px-PDF_file_icon.svg.png");
							$(".gazelle_partial").append("")//comment system
						}
						
						
						$(".gazelle_partial h3").empty();
						$(".main_table tbody").empty();
						$(".gazelle_partial h2").text(decodeHtml(doc.name).toProperCase())
						var personsCount = 0;
						if(doc.persons){

							doc.persons.forEach(function(person){
								personsCount++;
								$(".gazelle_partial h3").append("<a id='subhead_person_" +person._id + "'>" + person.name.toProperCase() + "</a>")
								if(personsCount < doc.persons.length){
									$(".gazelle_partial h3").append(", ");
								}

								//TODO this way people can copy links
								$("#subhead_person_" + person._id).attr("href", "/persons/" + person._id)

								$("#subhead_person_" + person._id).on('click', function(e){
									e.preventDefault();
									console.log("HERE")
									route("/persons/" + person._id)
									
								})
							})							
						}


						if(collection==="persons"){
							$(".gaz_img").attr("src", "http://www.pngmart.com/files/5/Anonymous-PNG-Image.png")
						}
						else if(collection==="classes"){
							//this is the gazelle class page, ie it lists members of a class 
							$(".main_table").hide();
							$(".collage").empty();
							$(".collage").show();
							$(".gaz_img").attr('src', "");

							if(doc.titleList){
								var count = true;
								//optionally duplicate torrent data in classes so that the $get is unnecessary
								var counter = 0;
								//so this is the class list of titles
								doc.titleList.forEach(function(title){
								//get title img

									//$.get("/doc/" + titleID + "?collection=titles", function(data){
										//if(data){
											var div = document.createElement('div');
											var a = document.createElement('a');
											$(a).attr("href", "/titles/" + title._id)
											$(a).attr("id", "class_title_" + title._id)									
											var img = document.createElement('img');
											//$(img).attr('src', unescapeHtml(data.doc.img));
											
											
											if(!title.img){
												$(img).attr('src', "https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/PDF_file_icon.svg/833px-PDF_file_icon.svg.png");
											}
											else{
												$(img).attr('src', unescapeHtml(title.img))
											}
											if(count){
												if(title.img){
													$(".gaz_img").attr('src', unescapeHtml(title.img))

												}
												else{
													$(".gaz_img").attr('src', "https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/PDF_file_icon.svg/833px-PDF_file_icon.svg.png")
												}
											}
											a.append(img);
											var titleSpan = document.createElement("span");
											var title_span_a = document.createElement("a");
											$(title_span_a).attr("href", "/titles/"+title._id);
											var tagSpan = document.createElement("span");
											
											$(titleSpan).addClass("collageSpan")
											$(tagSpan).addClass("collageSpan")
											$(title_span_a).text(decodeHtml(title.name).toProperCase())

											$(titleSpan).append(title_span_a);

											var personSpan = document.createElement("span");
											$(personSpan).addClass("collageSpan");

											var personCounter = 0;
											title.persons.forEach(function(person){
												var person_span_a = document.createElement('a');
												$(person_span_a).text(decodeHtml(person.name).toProperCase());
												$(personSpan).append(person_span_a);
												if(personCounter < title.persons.length - 1){
													$(personSpan).append(", ")
												}
												personCounter++;

												$(person_span_a).attr('href', "/persons/" + person._id)

												$(person_span_a).click(function(e){
													e.preventDefault();
													route("/persons/" + person._id)
												})
											})

											var date_span = document.createElement("span");
											if(title.date){
												$(date_span).text(" [" + title.date + "] ");
											}

											var docCount = 0;
											title.tags.forEach(function(tag){
												var tag_span_a = document.createElement("a")
												$(tag_span_a).attr("href", "/torrents?taglist="+tag)
												$(tag_span_a).click(function(e){
													e.preventDefault();
													route("/torrents?taglist="+tag)
												})
												$(tag_span_a).text(tag)												
												$(tagSpan).append(tag_span_a)
												if(docCount !== title.tags.length - 1){
													$(tagSpan).append(", ")
												}
												docCount++;
											})
											console.log(counter);
											var br;
											if(counter%	5 === 0){
												br = document.createElement("div");
												$(br).addClass("br");
												if(counter <= 4){
													$(br).attr("id", "bre_" + counter)
												}
												else{
													$(br).attr("id", "bre_2")
												}
												$(br).attr("id", "bre_" + counter)
												console.log("HERE COUNTER " + counter);
												$(".gazelle_partial .collage").append(br)
											}
											
											var collageDiv = document.createElement('div');
											$(collageDiv).addClass("collageDiv");


											$(div).append(a);
											$(div).append("<br>");
											$(div).append(collageDiv);
											$(collageDiv).append(titleSpan);
											$(collageDiv).append(date_span);
											if(title.persons.length > 0){
												$(collageDiv).append(" by ")
												$(collageDiv).append(personSpan);
											}
											$(collageDiv).append("<br>")
											$(collageDiv).append(tagSpan);

											if(counter <= 4){
											//	$(".gazelle_partial .collage #bre_1").append(div);
											}
											else{
											//	$(".gazelle_partial .collage #bre_2").append(div);					
											}
											$(".gazelle_partial .collage .br").last().append(div);
											counter++;
											
											count = false;
										//}
											
									//})
									
									//end forEach
								})
								$(".gazelle_partial").css({'height' : 'auto'});
								console.log("rendering img for class on gazelle partial")
							}
							
							
						}

						if(doc.img){
							console.log("rendering img on gazelle partial")
							$(".gaz_img").attr("src", unescapeHtml(doc.img))
						}
						$(".edit").attr("id", "edit_" + doc._id)
						$(".edit").data("collection", collection)
						if(doc.description){
							$(".description").text(decodeHtml(doc.description))
						}
						if(torrents){
							torrents.forEach(function(title){
								print_title_table(title);
								print_torrent_table(title._id, title.torrents);

							})
						}
						if(doc.torrents){
							print_torrent_table(doc._id, doc.torrents);

						}

						if(torrent_details){
							console.log(doc.torrents)

							var torrent = search(torrent_details, doc.torrents);
							print_torrent_details(torrent)
						}

						if(collection === "titles"){
							print_comment_system(doc.comments);
						}
						$(".gazelle_partial").show()
					})
				}



				function print_comment_system(comments){
					var div0 = $(".gazelle_partial #commentArea")
					
					$(div0).empty();
					var trip = document.createElement("input");
					$(trip).attr("type", "text");
					$(trip).attr("placeholder", "tripcode")
					var comment = document.createElement("textarea");
					$(comment).attr("id", "commentBody")
					var button = document.createElement("button");
					$(button).text("Comment")
					$(button).attr("id", "comment");

					$(button).click(function(e){
						e.preventDefault();
						console.log("click")
						var _id = window.location.pathname.split("/")[2];
						console.log(_id)
						$.post("/comment", {_id: _id, body : $("#commentBody").val(), trip: $("#commentTrip").val() }, function(data){

						})
					})
					$(div0).append(trip);
					$(div0).append("<br>")
					$(div0).append(comment);
					$(div0).append("<br>");
					$(div0).append(button)	
					if(comments){
						comments.forEach(function(comment){
							var div = document.createElement('div');
							$(div).addClass("comment");
							var div2 = document.createElement('div');
							$(div2).addClass("postHeading");
							$(div).append(div2);

							var span = document.createElement("span");
							$(span).text(comment.tripcode + " " + timeSince(Date.parse(comment.time)))
							$(div2).append(span);
							var div3 = document.createElement("div");
							$(div3).addClass("commentBody");
							$(div).append(div3)
							var p = document.createElement("p");
							$(p).text(comment.body);
							$(div3).append(p);
							$(div0).append(div);

						})	
					}				
					
					
					
				}

				//todo edit loc of this startup function call
				paginate();

				
				var numPages;
				function load_torrents(sort_by, order_by, taglist, terms, tags, types, search, publisher, date, format, person, bitrate, media, edition, number, pages, action){

					//history.pushState('/titles', '', '/titles');
					
					$(".main_table").show();
					if(taglist)	console.log("LOADING TAGS: " + taglist)
					console.log("LOAD TORRENTS---")
					$.get("/browse?sort_by="+sort_by+"&order_by="+order_by+"&search=" + search + "&page=" + currentPage + "&taglist="+taglist +"&tags="+tags+"&terms="+terms+"&types="+types+"&publisher="+publisher+"&date="+date+"&format="+format+"&person="+person + "&bitrate="+bitrate+"&media="+media+"&edition="+edition+"&number="+number+"&pages="+pages + "&action=" +action, function(data){
						console.log("ROOT--------------")
						console.log(data);
						if(data !== null){
							//currentPage = data.currentPage;
							numPages = data.numPages;	//TODO: deprecated?						
							$(".main_table tbody").empty();							
							data.titles.forEach(function(title){

								print_title_table(title);
								print_torrent_table(title._id, title.torrents);
								

							})		
						}
						$(".titles_partial").show();
					})
				}



				function load_classes(){
				
					//currentPage = 1;
					
					$(".main_table").show();
					$.get("/gazelle_classes?page=" + currentPage, function(data){
						$(".classes_partial").show();
							$(".main_table tbody").empty();
						data.classes.forEach(function(clas){
							$(".main_table tbody").append("<tr id='class_row_"+clas._id + "'><td class='gaz_style'></td><td><a id='class_" + clas._id + "' href='/classes/" + clas._id + "'>"+ clas.name +"</a></td><td class='taglist' id='taglist_" + clas._id + "'></td><td>"+ clas.numTitles + "</td><td>"+ timeSince(Date.parse(clas.time)) + "</td></tr>")

							var clasTagsCount = 0;
							console.log($("#class_tags_" + clas._id));
							clas.tags.forEach(function(tag){
								clasTagsCount++;
								console.log(tag);
								$("#class_row_" + clas._id + ' .taglist').append("<a id='class_tag_"+ tag + "' href='/torrents?taglist="+tag+"'>"+ tag +"</a>") 
								$("#class_row_" + clas._id + " #class_tag_"+ $.escapeSelector(tag)).click(function(e){
									e.preventDefault();
									console.log("routing to tag")
									currentPage = 1;
									route("/torrents?taglist="+tag);
								})
								if(clasTagsCount !== clas.tags.length){
									$("#class_row_" + clas._id + " .taglist").append(", ");
								}
							})

							$("#class_" + clas._id).click(function(e){
								e.preventDefault();
								route("/classes/" + clas._id);
							})
						})
						$(".classes_partial").show();
					})
				}

				function load_titles(collection, id){
					$.get("/doc/" + id + "?collection=" + collection, function(data){
						console.log(data);
						$(".gazelle_partial").show();
						$(".gazelle_partial h2").text(data.name);
						//console.log(data.img);
						//console.log(decodeURI(data.img));
						$(".gazelle_partial img").attr("src", decodeHtml(data.img))
						print_torrent_table(title._id, data.torrents);	

					})
				}

				function print_title_table(title){

					var date_span = title.date ? "<span><b> [" + title.date + "]</b></span>" : "";

					var max_size_span = title.max_size ? prettyBytes(title.max_size) + " (Max)": "" ;

					var time_span = title.time ? timeSince(Date.parse(title.time)) : "";

					var snatched_span = title.snatched ? title.snatched : "";

					$(".main_table tbody").append("<tr id='title_" + title._id + "' class='title_row'><td class='gaz_style'></td><td><a class='title_ref' href='/titles/" + title._id + "'><b>"+unescapeHtml(title.name).toProperCase() +"</b></a>"+ date_span +"<span id='title_persons_by_" + title._id + "'></span> <span class='title_persons'></span> <br><span class='title_tags'></span></td><td>" + time_span + "</td><td id='title_size'>" + max_size_span + "</td><td>" + snatched_span +"</td></tr>")
								
					$('#title_' + title._id + ' .title_ref').click(function(e){
						e.preventDefault();
						route("/titles/" + title._id)
					})

					if(title.persons.length > 0){
						$("#title_" + title._id + " #title_persons_by_"+title._id).text(' by ')

					}	

							
					var tagCount = 0;
					title.tags.forEach(function(tag){
						tagCount++;
						if(tag){
							$("#title_" + title._id + " .title_tags").append("<a class='tag' id='tag_" + tag + "_" + tagCount + "' href='#'>"+tag+"</a>")


							if(title.tags.length > 0 && title.tags.length !== tagCount){
								$("#title_" + title._id + " #tag_" + $.escapeSelector(tag) + "_" + tagCount).append(", ")
						
							}
						}
						
						$("#title_" + title._id + " .title_tags").on('click', '#tag_' + $.escapeSelector(tag) + "_" + tagCount, function(e){
							e.preventDefault()
								//TODO: add params to routes
								
								console.log("/torrents?taglist="+tag)
							currentPage = 1;
							route("/torrents?taglist=" + tag)
							
						})
					})

					var count = 1;
					//console.log(title.persons);
					title.persons.forEach(function(person){
						
						$("#title_" + title._id + " .title_persons").append("<a id='person_" + person._id+ "' class = 'person_ref' href='#'>" + person.name.toProperCase() + "</a>")
						/*if(count > 1){
							$("#person_" + person._id).append(", ");
						}*/
						//TODO append comma

						if(title.persons.length > 0 && title.persons.length !== count){
							$("#title_" + title._id  + " #person_" + person._id).append(", ")
						}

						//so links can be copied
						$("#title_" + title._id + " #person_" + person._id).attr("href", "/persons/" + person._id)

						$("#title_" + title._id + " #person_" + person._id).click(function(e){
							e.preventDefault();
							console.log("HERE");
							route("/persons/" + person._id);							
						})
						count++;
					})
				}

				function print_torrent_table(titleID, torrents){
					var arr = _.groupBy(torrents, "publisher")	

					
					for (var key in arr) {					
						var publisher = "Standard Edition"
						if(arr[key][0].edition || arr[key][0].pages || arr[key][0].publisher){

							var edition = ""
							if(arr[key][0].edition){
								edition = arr[key][0].edition.toProperCase() + " / ";
							}

							var pages = ""
							if(arr[key][0].pages){
								pages = "#"+ arr[key][0].pages + " / "
							}

							
							if(arr[key][0].publisher){
								console.log(arr[key][0].publisher + " HERE");
								
								publisher = arr[key][0].publisher.toProperCase()
							}
							
							
						}

						$(".main_table tbody").append("<tr class='edition_row'><td class='gaz_style'></td><td><b>"+ publisher + "</b></td><td></td><td></td><td></td></tr>")

						var infoHashes = []
					    if (arr.hasOwnProperty(key)) {
					        arr[key].forEach(function(tor){

					        	var media;
					        	if(!tor.media){
					        		media = "";
					        	}
					        	else{
					        		media = tor.media + " / ";
					        	}

					        	var release = ""
					        	if(tor.release){
					        		release = tor.release + " / "
					        	}

					        	var publisher = "Standard Edition"
					        	if(tor.publisher){
					        		publisher = tor.publisher.toProperCase()
					        	}

					        	var edition = ""
					        	if(tor.edition){
					        		edition = "ed. " + tor.edition.toProperCase() + " / "
					        	}

					        	var pages = ""
					        	if(tor.pages){
					        		pages = "pp. " + tor.pages + " / "
					        	}

					        	var number = ""
					        	if(tor.number){
					        		number = "no. " + tor.number + " / " 
					        	}

					        	var codec = "";
					        	if(tor.codec){
					        		codec = tor.codec + " / "
					        	}
					        	
					        	var format = "";
					        	if(tor.format){
					        		format = tor.format + " / ";
					        	}
					        	var bitrate = "";
					        	if(tor.bitrate){
					        		bitrate = tor.bitrate + " / "
					        	}
					        	
					        	var time = "";
					        	if(tor.time){
					        		time = timeSince(Date.parse(tor.time));
					        	}
					        	
					        	var snatches = ""
					        	if(tor.snatched != null){
					        		snatches = tor.snatched;
					        	}

					        	

					        	console.log(tor.snatched);
					        	$(".main_table tbody").append("<tr id='torrent_row_" + tor.infoHash + "' class='torrent_row'><td class='gaz_style'></td><td id='data_"+tor.infoHash + "'><a href='/titles/"+titleID + "?torrent_details=" + tor.infoHash + "' class='torrent_details' id='details_" + tor.infoHash + "' href='#'>" + release + edition + number+ pages + media + codec + format + bitrate + tor.tripcode + "</a><span class='dl'><a href='magnet:?xt=urn:btih:"+tor.infoHash+"&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337'>[MG]</a><a href='#' class='download_torrent' id='dl_" + tor.infoHash + "'>[DL]</a></span></td><td class='tor_time'>" + time + "</td><td class='tor_size'>"+ prettyBytes(tor.size) +"</td><td id='snatches'>"+ snatches + "</td></tr>")
					        	
					        	/*$(".torrent_details").on('click', function(e){					        		
					        			e.preventDefault();
					        			console.log("here");
					        	})*/


					        	$(".main_table #dl_"+tor.infoHash).on('click', function(e){
									e.preventDefault();
					        		console.log($(this).prev().attr('href'));
									downloadTorrent($(this).prev().attr('href'));					        	
																      
								})
								$("#details_"+tor.infoHash).on('click', function(e){
					        		e.preventDefault();
					        		route("/titles/" + titleID + "?torrent_details=" + tor.infoHash);  

					        	})

					        })

					        	
					        	
					       
					    }
					}
				}

				function print_torrent_details(torrent){
					$("<tr class='torrent_details_row'><td class='gaz_style'></td><td colspan='4'><div class='details_box'><p><span>Uploaded by " + torrent.trip + " </span><span>" + timeSince(Date.parse(torrent.time)) + "</span></p></div><div class='details_box'><p><span>Media: " + torrent.media + "</span><br><span>Codec: " + torrent.codec + "</span><br><span>Format: " + torrent.format + "</span><br><span>" + torrent.bitrate +"</span></p></div></td></tr>").insertAfter($("#torrent_row_" + torrent.infoHash))
				}

				function downloadTorrent(href){
					client.add(href, function(torrent){

						torrent.files.forEach(function(file){
							file.appendTo('.log')
						})
						//torrent.files[0].appendTo("body")//#data_" + torrent.infoHash
						//$("#data_" + torrent.infoHash).css("height", "350px")
						
										 // Trigger statistics refresh
				        torrent.on('done', onDone)
				        setInterval(onProgress, 500)
				        onProgress()

				         // Statistics
				        function onProgress () {
				          // Peers
				          $numPeers.innerHTML = torrent.numPeers + (torrent.numPeers === 1 ? ' peer' : ' peers')

				          // Progress
				          var percent = Math.round(torrent.progress * 100 * 100) / 100
				          $progressBar.style.width = percent + '%'
				          $downloaded.innerHTML = prettyBytes(torrent.downloaded)
				          $total.innerHTML = prettyBytes(torrent.length)

				          // Remaining time
				          var remaining
				          if (torrent.done) {
				            remaining = 'Done.'
				          } else {
				            remaining = moment.duration(torrent.timeRemaining / 1000, 'seconds').humanize()
				            remaining = remaining[0].toUpperCase() + remaining.substring(1) + ' remaining.'
				          }
				          $remaining.innerHTML = remaining

				          // Speed rates
				          $downloadSpeed.innerHTML = prettyBytes(torrent.downloadSpeed) + '/s'
				          $uploadSpeed.innerHTML = prettyBytes(torrent.uploadSpeed) + '/s'
				        }
				        function onDone () {
				         // $body.className += ' is-seed'
				          onProgress()				          
				          $.post("/snatched", {infoHash: torrent.infoHash}, function(data){

				          })
				        }


					})
				}

				function load_index(){
					//history.pushState('/index', '', '/index')
					$.get("/load_index", function(data){
						console.log(data);
						$("#indexTiles").empty()
						

						data.result.forEach(function(title){

							console.log(title.name);
							var div = document.createElement('div');
							$(div).addClass('indexTile')
							var a = document.createElement('a');

							

							$(a).click(function(e){
								e.preventDefault();
								route("/titles/"+ title._id)
							})
							$(a).attr("href", "/titles/" + title._id)
							var imgURL = "https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/PDF_file_icon.svg/1200px-PDF_file_icon.svg.png"
							if(title.img){
								imgURL = title.img;
							}

							var img = document.createElement("img");
							$(a).append(img)
							$(img).attr("src", imgURL);
							$(div).append(a);
							$(div).append("<br>")

							var titleS = document.createElement("span");
							var titleA = document.createElement('a');
							$(titleS).append(titleA);
							$(titleA).text(title.name.toProperCase());
							$(titleA).attr('href', "/titles/" + title._id)
							$(titleA).click(function(e){
								e.preventDefault(load_index);
								route("/titles/" + title._id);
							})

							var time = document.createElement("span");
							$(time).text(timeSince(Date.parse(title.time)));

							var tripcode = document.createElement("span");
							var tripcodeA = document.createElement("a");
							//find most recent torrent
							$(tripcodeA).text("Anonymous");
							if(title.recentTrip){
								$(tripcodeA).text(title.recentTrip);
							}
							$(tripcode).append(tripcodeA);
							$(div).append(titleS);
							$(div).append("<br>")
							$(div).append(time);
							$(div).append("<br>")
							$(div).append(tripcode)
							$("#indexTiles").append(div);
						})
						$(".index_partial").show();
					})
				}		

				function load_upload(){
					persons = [];
					//TODO make sure this works
					$("#persons_upload").remove();
					$(".torrent_size").remove();
					$(".added_person").remove();
					$(".upload_partial").show();
				}

				$("input:file").change(function(){
					var files = this.files; 
					client.seed(files, function(torrent){
						$("#infoHash").val(torrent.infoHash);
						$(".upload").append("<a href='" + torrent.torrentFileBlobURL + "'>seed .torrent</a><a href='https://webtorrent.io/desktop/' target='_blank'> (cf. Webtorrent Desktop) </a>")
						$('<input />').attr('type', 'hidden')
					        .attr("name", "size")
					        .addClass('torrent_size')
					        .val(torrent.length)
					        .appendTo('.upload');	
						})
				})

				$('.upload').submit(function(){ //listen for submit event
				    $('<input />').attr('type', 'hidden')
				    	.attr('id', 'persons_upload')
				        .attr('name', "persons[]")
				        .val(JSON.stringify(persons))
				        .appendTo('.upload');							   
				    persons = [];
				    route("/index");
				    console.log($("#persons_upload").val());
				    return true;
				}); 

				var persons = [];

				$("#doc_add_person").click(function(e){
					var that = this;
					e.preventDefault();
					$.post("/add_person", {'name' : $("#doc_person").val()}, function(data){
						$(that).next().after("<span class='added_person'><br>" + data.name + "</span><br>")
						var importance = $("#docPersonImportance").val();
						var role = $("#docPersonRole").val();
						appendPerson(data._id, data.name, importance, role)
					})
				})

				$("#doc_create_person").click(function(e){
					var that = this;
					e.preventDefault();
					$.post("/create_person", {'name' : $("#doc_person").val()}, function(data){
						$(that).next().after("<span class='added_person'><br>" + data.name + "</span>")
						var importance = $("#docPersonImportance").val();
						var role = $("#docPersonRole").val();
						appendPerson(data._id, data.name, importance, role)
					})
				})

				$(".add_person").click(function(e){
					var that = this;
					e.preventDefault();
					$.post("/add_person", {'name' : $("#upload_person").val() }, function(data){
						$(that).next().after("<span class='added_person'><br>"+data.name+"</span>")
						var importance = $("#personImportance").val();
						var role = $("#personRole").val();
						appendPerson(data._id, data.name, importance, role)
					})			

				})

				$(".create_person").click(function(e){
					var that = this;
					e.preventDefault();
					$.post("/create_person", {'name' : $("#upload_person").val() }, function(data){
						$(that).after("<span class='added_person'><br>"+data.name+"</span>")
						var importance = $("#personImportance").val();
						var role = $("#personRole").val();
						appendPerson(data._id, data.name, importance, role)
					})
				})

				function appendPerson(id, name, importance, role){
					persons.push({"_id" : id, "name" : name, "importance" : importance, "role" : role})
				}
						

				function paginate(){
					var collection = window.location.pathname.split("/")[1];
					if(collection === "class"){
						collection = "classes";
					}
					const urlParams = new URLSearchParams(window.location.search);
					const view = urlParams.get('view');
					const doc = urlParams.get('doc');
					const taglist = urlParams.get('taglist');
					const tags= urlParams.get('tags');
					const terms = urlParams.get('terms');
					const types = urlParams.get('types');
					const publisher = urlParams.get('publisher');
					const date = urlParams.get('date');
					const format = urlParams.get('format');
					const person = urlParams.get('person')
					const edition = urlParams.get('edition')
					const number = urlParams.get('number');
					const pages = urlParams.get('pages');
					const media = urlParams.get("media");
					const bitrate = urlParams.get("bitrate")

					var action = urlParams.get('action');
					//search=true etc
					const search = urlParams.get("search")

					//comment system pagination
					/*var titleID;
					if(collection === "titles"){
						titleID = window.location.pathname.split("/")[2];
					}*/
					//todo: right page count with taglist search query param, TODO more searchterms 
					$.get("/pagination", {media: media, bitrate: bitrate, edition:edition, number:number, pages: pages, action: action, publisher: publisher, date : date, format: format, person : person, collection : collection, view: view, terms: terms, tags: tags, types: types, search: search, doc :doc, taglist : taglist}, function(data){
						if(data !== null){
							$(".pagination").append("TEST");
							console.log(data.numPages);
							$(".pagination").empty();
							
					
							var previousPage;
							if(parseInt(currentPage) === 1){
								previousPage = 1;
							}
							else{
								previousPage = parseInt(currentPage) - 1;
							}

							var nextPage;
							if(parseInt(currentPage) === data.numPages){
								 nextPage = data.numPages;
							}
							else{
								nextPage = parseInt(currentPage) + 1;
							}

							//TODO: Show link in page url

							if(parseInt(currentPage) - 5 > 1){
								var index = parseInt(currentPage) - 5
							}
							else{
								var index = 1;
							}

							if(parseInt(currentPage) + 5 > data.numPages){
								var index2 = data.numPages;
							}
							else{
								var index2 = parseInt(currentPage) + 5;
							}

							var firstURL = updateURLParameter((window.location.pathname + window.location.search), "page", 1)
							var prevURL = updateURLParameter((window.location.pathname + window.location.search), "page", currentPage)
							var nextURL = updateURLParameter((window.location.pathname + window.location.search), "page", currentPage)
							var lastURL = updateURLParameter((window.location.pathname + window.location.search), "page", currentPage)
 
							$(".pagination").append("<a href='" + firstURL +"' class='page_"+ 1 +"'> [First] </a> ")
							$(".pagination").append("<a href='" + prevURL + "' class='page_"+ previousPage +"'> [Prev] </a> ")
							for(var i = 0; i < 10; i++){
								$(".pagination").append("<a href class='page' id='pager_" + i + "'></a>")
							}

							var counter = 0;
							console.log(index, index2)
							for(var i = index; i <= index2; i++){
								
								$(".pagination #pager_"+counter).text(" ["+ i + "] ");
								$(".pagination #pager_"+ counter).addClass("page_" +i);
								counter++;
							}
													
							//$(".pagination").append("<a href class='page_" + (parseInt(currentPage) + 9) + "'>"+ (parseInt(currentPage) + 9) + "</a> | ")
							
							$(".pagination").append("<a href='" +nextURL+ "' class='page_"+ nextPage +"'> [Next] </a>")
							$(".pagination").append("<a href='"+ lastURL +"' class='page_" + data.numPages + "'> [Last] </a>")
							
							$(".pagination a").click(function(e){
								e.preventDefault();
								var className = $(this).attr("class");
								currentPage = getSuffix(className);
								var pageNumber = getSuffix($(this).attr("href"));

								console.log("ROUTING FROM PAGE TO " + window.location.pathname + window.location.search)
								route(updateURLParameter((window.location.pathname + window.location.search), "page", currentPage));	
								
								
							})
						}
					})
					
				}

				/**
				 * http://stackoverflow.com/a/10997390/11236
				 */
				function updateURLParameter(url, param, paramVal){
				    var newAdditionalURL = "";
				    var tempArray = url.split("?");
				    var baseURL = tempArray[0];
				    var additionalURL = tempArray[1];
				    var temp = "";
				    if (additionalURL) {
				        tempArray = additionalURL.split("&");
				        for (var i=0; i<tempArray.length; i++){
				            if(tempArray[i].split('=')[0] != param){
				                newAdditionalURL += temp + tempArray[i];
				                temp = "&";
				            }
				        }
				    }

				    var rows_txt = temp + "" + param + "=" + paramVal;
				    return baseURL + "?" + newAdditionalURL + rows_txt;
				}

			
				function insertParam(key, value) {
				    key = encodeURIComponent(key);
				    value = encodeURIComponent(value);

				    // kvp looks like ['key1=value1', 'key2=value2', ...]
				    var kvp = document.location.search.substr(1).split('&');
				    let i=0;

				    for(; i<kvp.length; i++){
				        if (kvp[i].startsWith(key + '=')) {
				            let pair = kvp[i].split('=');
				            pair[1] = value;
				            kvp[i] = pair.join('=');
				            break;
				        }
				    }

				    if(i >= kvp.length){
				        kvp[kvp.length] = [key,value].join('=');
				    }

				    // can return this or...
				    let params = kvp.join('&');

				    // reload page with new params
				    document.location.search = params;
				}
				
			

				//magnet:?xt=urn:btih:220d371932c5eccef31373d6bf8e811011e559ee&dn=Continental+Tarots.pdf&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337

				//advanced search
				function delay(callback, ms) {
				  var timer = 0;
				  return function() {
				    var context = this, args = arguments;
				    clearTimeout(timer);
				    timer = setTimeout(function () {
				      callback.apply(context, args);
				    }, ms || 0);
				  };
				}
				
				$(".adv_search input").keyup(function(e){
					e.preventDefault();
					var collection = getSuffix($(this).attr('id'));
					
					$.post("/adv_search?collection=" + collection, { "text" : $(this).val() }, function(data){
						console.log(data.documents);
						$("#realtime_" + collection ).empty();
						if(data.documents.length > 0){
							$("#realtime_" + collection).show();
							var threadIDs = [];
							data.documents.forEach(function(doc){
								if(collection === "forums"){									
									if(!threadIDs.includes(doc.threadID)){
										threadIDs.push(doc.threadID);
										$("#realtime_" + collection).append("<span><a href='/forums?view=thread&doc=" + doc.threadID + "' class='realtime_a' id='realtime_" + doc.threadID + "'>" + doc.threadTitle.toProperCase() + "</a></span><br>")
										$("#realtime_" + doc.threadID).click(function(e){
										e.preventDefault();
										var id = getSuffix($(this).attr('id'));
										route("/forums?view=thread&doc=" + id)
										
									})
									}									
								}
								else{
									$("#realtime_" + collection).append("<span><a href='/" + collection + "/" + doc._id + "' class='realtime_a' id='realtime_" + doc._id + "'>" + doc.name.toProperCase() + "</a></span><br>")
									$("#realtime_" + doc._id).click(function(e){
										e.preventDefault();
										console.log("here")
										var id = getSuffix($(this).attr('id'));
										console.log(id);										
										route("/" + collection + "/" + id);
										
									})
								}
								
								
								$('body').click(function(evt){    
							       if(evt.target.id === "realtime_" + collection)
							          return;
							     
							      $("#realtime_" +collection).hide();
							      //Do processing of click event here for every element except with id menu_content

								});
							})			
						}
						else{
							$("#realtime_" + collection).hide();
						}

					})
				})

				function timeSince(date) {

				  var seconds = Math.floor((new Date() - date) / 1000);

				  var interval = seconds / 31536000;

				  if (interval > 1) {
				    return Math.floor(interval) + " years ago";
				  }
				  interval = seconds / 2592000;
				  if (interval > 1) {
				    return Math.floor(interval) + " months ago";
				  }
				  interval = seconds / 86400;
				  if (interval > 1) {
				    return Math.floor(interval) + " days ago";
				  }
				  interval = seconds / 3600;
				  if (interval > 1) {
				    return Math.floor(interval) + " hours ago";
				  }
				  interval = seconds / 60;
				  if (interval > 1) {
				    return Math.floor(interval) + " minutes ago";
				  }
				  return Math.floor(seconds) + " seconds ago";
				}

				function unescapeHtml(unsafe) {
				    return unsafe
				        .replace(/&amp;/g, "&")
				        .replace(/&lt;/g, "<")
				        .replace(/&gt;/g, ">")
				        .replace(/&quot;/g, "\"")
				        .replace(/&#039;/g, "'")
				        .replace(/&#x2F;/g, "/")
				}

				function decodeHtml(html) {
				    var txt = document.createElement("textarea");
				    txt.innerHTML = html;
				    return txt.value;
				}

				function getSuffix(str){
					return str.substring(str.indexOf('_') + 1);
				}

				String.prototype.toProperCase = function () {
				    return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
				};

				function search(nameKey, myArray){
					console.log(myArray);
					console.log(nameKey);
				    for (var i=0; i < myArray.length; i++) {
				    	console.log(myArray[i].infoHash)
				        if (myArray[i].infoHash === nameKey) {

				            return myArray[i];
				        }
				    }
				}

				function prettyBytes(num) {
			        var exponent, unit, neg = num < 0, units = ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
			        if (neg) num = -num
			        if (num < 1) return (neg ? '-' : '') + num + ' B'
			        exponent = Math.min(Math.floor(Math.log(num) / Math.log(1000)), units.length - 1)
			        num = Number((num / Math.pow(1000, exponent)).toFixed(2))
			        unit = units[exponent]
			        return (neg ? '-' : '') + num + ' ' + unit
			      }			



			})
			
		</script>
		<style>

	      #progressBar {
	          height: 5px;
	          width: 0%;
	          background-color: #35b44f;
	          transition: width .4s ease-in-out;
	      }
	      body.is-seed .show-seed {
	          display: inline;
	      }
	      body.is-seed .show-leech {
	          display: none;
	      }
	      .show-seed {
	          display: none;
	      }
	      #status code {
	          font-size: 90%;
	          font-weight: 700;
	          margin-left: 3px;
	          margin-right: 3px;
	          border-bottom: 1px dashed rgba(255,255,255,0.3);
	      }

	      .is-seed #hero {
	          background-color: #154820;
	          transition: .5s .5s background-color ease-in-out;
	      }
	      #hero {
	          background-color: #2a3749; /* #179b9f;#ecdb82;*/
	          background-color: #2a3749;
	          border:1px solid #5c3046;
	          box-sizing: border-box;
	          width:100%;
	      }
	      #status {
	          color: #30a247;/*coral;*/ /*#ecdb82;*/
	          color: #ac1db8;
	          color: white;
	          font-size: 17px;
	          padding: 5px;
	      }
	      a {
	          color: #2a3749;
	          text-decoration: none;
	          font-family:"Oswald",sans-serif;
	      }

	      .details_box{
	      	border-style: dotted;
	      }

	      body{
				background-color:#e6e6ff;
				background-color:#32a852;
				background-color:#419169;
				background-color: #84c76f;
				background-color: #94e0a3;
				background-color:#80bf91;
				background-color: #ebe5be;
				width:100%;

			}

	      #text{
	      	display: none;
	      }
	      .post{
	      	margin:55px;
	    /*  	border:3px solid #9fccaa;*/
	      }
	    
	    .post p{
	    	background-color:#e6e6ff;
	    	font-size:12px;
	    }

	      .postHeading{
	      	width:100%;
	      	height:55px;
	      	background-color:#c8dbd5;
	      	border-radius:7px;
	      }

	

	      .heading{
	      	font-family:Arial;
	      }

	      .indexPost{
	      	margin-top: 33px;
	      	font-size: 12px;
	      }

	      .indexPost p{
	      	background-color: white;
	      }

	     
			/* http://meyerweb.com/eric/tools/css/reset/ 
   v2.0 | 20110126
   License: none (public domain)
*/	

			html, body, div, span, applet, object, iframe,
			h1, h2, h3, h4, h5, h6, p, blockquote, pre,
			a, abbr, acronym, address, big, cite, code,
			del, dfn, em, img, ins, kbd, q, s, samp,
			small, strike, strong, sub, sup, tt, var,
			b, u, i, center,
			dl, dt, dd, ol, ul, li,
			fieldset, form, label, legend,
			table, caption, tbody, tfoot, thead, tr, th, td,
			article, aside, canvas, details, embed, 
			figure, figcaption, footer, header, hgroup, 
			menu, nav, output, ruby, section, summary,
			time, mark, audio, video {
				margin: 0;
				padding: 0;
				border: 0;
				font-size: 100%;
				font: inherit;
				vertical-align: baseline;
			}
			/* HTML5 display-role reset for older browsers */
			article, aside, details, figcaption, figure, 
			footer, header, hgroup, menu, nav, section {
				display: block;
			}
			body {
				margin:0;
				padding:0;

				line-height: 1;
			}
			ol, ul {
				list-style: none;
			}
			blockquote, q {
				quotes: none;
			}
			blockquote:before, blockquote:after,
			q:before, q:after {
				content: '';
				content: none;
			}
			table {
				border-collapse: collapse;
				border-spacing: 0;
		
			}

			h1{
				padding:8px;
				width:150px;
				height: 75px;
				float: left;
			}

			.panel{
				float: left;
				margin-left: 88px;
			}

			h2 a{
				padding:0px;
				color: white;
			}

			.quote{
				color: #30a247;
			}

			#commentArea{
				width: 88%;
				margin:  0 auto;
			}

			.comment{
				background-color: white;
				margin: 33px;
				margin-left: 0px;
				border: 1px solid #CDECDC;
				font-size: 12px;
			}

			p{
				padding:8px;
			}

			.partial{
				padding: 8px;
			}
			
			.details_box{
				border: 1px dotted black;
				border-style: dotted;
				padding: 6px;
			}

			h1 a{
				font-size:26px;
				color:white; /*#2a3749;*/
				font-family:Georgia;

				text-shadow:2px 3px coral;
				background-image: linear-gradient(to left, violet, indigo, blue, green, yellow, orange, red);
				
			}

			.tripSpan{
				float:right;
			}

			.heading{
				font-family:Georgia;
				padding:125px;
				padding-left:0px;
			}

			#spanRight{
				float:right;
			}

			.heading li, .panel li{
				float:left;
				padding:9px;
			}

			.panel{
				font-size:13px;
				padding: 9px;
				padding-left: 0px;

			}

			
			.post{
				white-space: pre-wrap;
			}
			.add_class{
				float:right;
			}

			.upload input{
				
			}

			.basicSearch{
				width:442px;
				height:300px;
				margin:0 auto;
				border:1px solid #5c3046; /*692aa8*/
				background-color:#c8dbd5;
				background-color: #66ff89;
				background-color: #00E32D;
				background-color: #2a3749;
				padding:32px;
				margin-bottom:45px;
				margin-top: 41px;
			}

			.basicSearch li{
				float:left;
				font-family:Georgia;
				color: white;
			}

			.basicSearch a{
				color: coral;
			}

			.basicSearch ul{
				float:none;
				height:55px;
				clear:both;
				width:100%;
			}

			.basicSearch button{
				clear:both;
			}

			.hidden{
				display:none;
			}

			.search_bar li{
				float:left;
			}

			.adv_search input{
				width:178px;
				margin:8px;
			}

			.indexTile{
				margin: 8px;
				padding: 16px;
				text-align: center;
			}

			.gaz_img{
				padding:32px;
			}

			.gazelle_partial h3{
				padding:13px;
			}

			.realtime_search{
				width:178px;
				height:200px;
				display:none;
				background-color:white;
				position:absolute;
				padding: 8px;
				z-index:2;
				margin-top: -7px;
				margin-left: 5px;
				
			}

			.section_td{
				width:200px;
			}

			.last_post_td{
				width:300px;
			}

			.gaz_style{
				border-right:1px solid gold;
				width:55px;
			}

			.main_table{
				background-color:#e6e6ff;

			}

			.realtime_search a{
				color:#00E32D;;
				padding:2px;
				font-size:12px;
			}

			.index_partial{
				min-width: 1200px;
			}

			.index_partial span{
				width:100%;
				float:right;
				text-align:left;
			}

			.indexPost{
				width: 100%;
			}

			object{
				width:100%;
				height:555px;
			}

			h2{
				font-size:18px;
				padding:14px;
				padding-left: 0px;
				font-family:Georgia;
				
			}

			h3{
				font-family:Georgia;
			}

			.heading a, .panel a, h2 a{
				color: #4b375e;
				color: #5c3046;
			}

			.basicSearch a {
				color: #CDCDCD;
			}


			td{
				padding:7px;
			}

			.edit{
				float:right;
			}

			.title_row{
				padding:12px;
				height:33px;
				background-color:#c8dbd5;
			}

			.edition_row, .torrent_row{
				background-color:#DEDEDE;
				width:100%;
			}

			.main_table{
				width:85%;
				margin:0 auto;
				box-shadow: -5px 0px 5px -3px #616161;
				padding-left:15px;
			}

			.forums_partial .main_table{
				table-layout:fixed;
			}

			#replies{
				width:77px;
			}

			.main_table tr{
				border-bottom:1px solid #CDCDCD;
				font-size:12px;
				width:100%;
			}

			.dl{
				float:right;
			}

			.gazelle_partial img{
				width:176px;
				height:246px;
			}

			/*shady */
			.title_tags{
				position:relative;
				top:3px;
			}

			.forum_textarea{
				width:500px;
				height:300px;
			}

			.heading{

			}

			.top10_partial{
				width: 85%;
				margin: 0 auto;
				background-color: white;
			}
			
			.collage{
				padding:66px;
				font-size:12px;
				

			}

			.collage img{
				padding:12px;
				padding-bottom:0px;
				width:176px;
				height:246px;
			}

			.indexTile{
				float: left;
				width: 176px;
				display:  inline;
			}

			.indexTile img{
				padding: 12px;
				padding-bottom: 0px;
				width: 176px;
				height: 246px;
			}

			#indexTiles{
				height: 400px;
				width: 100%;
				background-color: white;
			}

			.tag{
				padding:2px;
				font-style:italic;
			}

			.collage .br div{
				width:176px;
				float:left;
				margin:12px;
				margin-top:0px;
			}

			.collageDiv{				
				background-color:#c8dbd5;
				background-image: linear-gradient(to bottom, #FFF 0%, #c8dbd5 100%);
				border-radius:4px;
				border-radius:0px 0px 6px 6px;
			}

			.collageSpan{
				width:176px;
				font-size:12px;
				clear:both;
				float:none;
				background-color:#c8dbd5;
			}

			.tagSpan{
				font-style:italic;	
			}

			.top10_partial .collage{
				height: 650px;
			}

			.br{
				float:none;
				clear:both;
				width:1024px;
			}

			#commentBody{
				width: 40%;
				height: 500px;
			}
			

			td{
				border:1px solid #CDCDCD;
			}

			body{
	      		font-family:Arial, sans-serif;
	     	}

	     	a:hover{
	      		color:gold;
	      	}

		</style>
	</body>
</html>